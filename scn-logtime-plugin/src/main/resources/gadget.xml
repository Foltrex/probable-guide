<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <ModulePrefs author="ScienceSoft"
                 title="JIRA LogTime Gadget"
			directory_title="ScienceSoft LogTime Gadget"
			description="A sample gadget to install into JIRA."
            screenshot='#staticResourceUrl("com.scn.jira.scn-logtime-plugin:logtime-gadget", "logtime-gadget-screenshot.png")'
            thumbnail='#staticResourceUrl("com.scn.jira.scn-logtime-plugin:logtime-gadget", "logtime-gadget-thumb.png")'>
        <Optional feature="gadget-directory">
            <Param name="categories">
                JIRA
            </Param>
        </Optional>
		<Require feature="dynamic-height"/>
		<Require feature="setprefs" />
        <Require feature="views" />
        <Optional feature="atlassian.util" />
        <Optional feature="auth-refresh" />
        <Require feature="oauthpopup" />
        <Require feature="settitle"/>
        #oauth

     <Locale messages="__ATLASSIAN_BASE_URL__/download/resources/scn-logtime-plugin/i18n/ALL_ALL.xml"/> 
     #supportedLocales("gadget.common")
   
    </ModulePrefs>
    
    <UserPref name="isConfigured" datatype="hidden" default_value="true" />   
	<UserPref name="project"  default_value="1"/>
	<UserPref name="wlScnCheck"  datatype="bool"  default_value="true"/>
	<UserPref name="wlExtCheck" datatype="bool" default_value="false"/>
	<UserPref name="projectlist" datatype="list" default_value="0"/>
	<UserPref name="userslist" datatype="list" default_value=""/>	
	<UserPref name="refresh" datatype="hidden" default_value="false" />
	<UserPref name="width" default_value="1200" />
    <Content type="html" view="profile">
        <![CDATA[

		#requireResource("com.atlassian.jira.webresources:select-pickers")
        #requireResource("com.atlassian.jira.gadgets:common")
        #requireResource("com.atlassian.gadgets.publisher:ajs-gadgets")
        #requireResource("com.atlassian.jira.gadgets:g-filter-results")
        #requireResource("com.atlassian.auiplugin:ajs")
        #requireResource("com.scn.jira.scn-logtime-plugin:logtime-resources")

        #includeResources()
        
        <br/>

        <table>
        <tbody>
            <tr>
                <td nowrap style="padding-left:10px;">
                    <select id="s1" multiple="">
                        <option>All projects</option>
                    </select>
                </td>
                <td id="wlsc" class="filterCheck" nowrap style="padding-left:10px">
                    <div style="width: 100%; display: flex;">
                        <div style="width: 50px">
                            <input id="ScnWl" type="checkbox" onclick="checkboxScnClick()" name="ScnWL" value="ScnWL" checked>
                            <label for="ScnWl" name="checkbox2_lbl" >WL*</label>
                        </div>
                        <div style="width: 50px">
                            <input id="ExtWl" type="checkbox" onclick="checkboxExtClick()" name="ExtWL" value="ExtWL" checked>
                            <label for="ExtWl" name="checkbox2_lbl2" >WL</label>
                        </div>
                    </div>
                </td>

                <td class="filterEmployee" nowrap>
                    <label> Employee(s) </label>
                </td>

                <td class="filterUser" nowrap>
                    <fieldset rel="myFieldId" class="hidden user-picker-params">
                        <input type="hidden" id="formName" value="jiraform">
                        <input type="hidden" id="fieldName" value="myFieldId">
                        <input type="hidden" id="multiSelect" value="true">
                        <input type="hidden" id="userPickerEnabled" value="true">
                    </fieldset>

                    <div class="ajax_autocomplete" id="myFieldId_container">
                        <input type="text" name="myFieldId" id="myFieldId" value="" class="userpickerfield text" size="21"/>
                        <br/><div id="myFieldId_results" class="ajax_results"></div>
                        <div id="noUser" style="color:red;display:none;">Please, specify at least one employee </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="emptyTd"><td>
            </tr>
		</tbody>
		</table>
        <table>
        <tbody>
            <tr>
                <td class="filterView">
                    <div style="display: flex;">
                        <button id="backbtn" class="back-btn" onclick="slideBack()" > </button>
                        <label id="periodId"></label>
                        <button id="forwardbtn" class="forward-btn" onclick="slideForward()" > </button>
                        <button id="viewButton" class="btn-view" style="margin-left:20px" onclick="changeView()">Weekly view</button>
                        <button class="showWorklog" style="margin-left:10px" onclick="reloadMeClean()">Show Work Log </button>
                    </div>
                </td>
                <script type="text/javascript">
                    var buttonNameText=document.getElementById('viewButton').innerHTML;
                </script>
            </tr>
		</tbody> 
		</table>

		<br></br>

		 <script type="text/javascript">
			 			 
			    // Get userprefs
			   //var prefs = new gadgets.Prefs();
			
			   //document.getElementById('ScnWl').checked=prefs.getBool("wlScnCheck"); 
			   //document.getElementById('ExtWl').checked=prefs.getBool("wlExtCheck");
			   document.getElementById('ScnWl').checked=true; 
			   document.getElementById('ExtWl').checked=false; 
			   
			   var usersSelected = "";
			 // var usersSelected = prefs.getArray("userslist"); 	
          	           
			   //document.getElementById('myFieldId').value=usersSelected; 
			   var currentPeriod=0;			 				 		   
		  	   var slideStep=0;
		  	   
		  	   var scnWlCheck=document.getElementById('ScnWl').checked==true?1:0;     
               var extWlCheck=document.getElementById('ExtWl').checked==true?1:0;
               var assignedCheck=0;//document.getElementById('Assigned').checked==true?1:0;
               
               
             //  var buttonNameText=document.getElementById('viewButton').innerHTML;
               
             
               var search_project = "0";//prefs.getString("projectlist");	
          	
               var projectArr=[];
               
	           var prj_check_list=[];
	           var prj_check_list_string="";
	           var prj_check_cnt;
	           
	          
               if(usersSelected==""){
          	   		//document.getElementById('myFieldId').value=document.getElementById('userHidden').value;
          	   		usersSelected=document.getElementById('myFieldId').value;
          	   		
          	   }
                // :(
                setTimeout(function() {
                    while (true) {
                        if (jQuery("#myFieldId") && jQuery("#myFieldId")[0] && jQuery.data(jQuery("#myFieldId")[0], "events" ) &&
                            jQuery.data(jQuery("#myFieldId")[0], "events" )["keyup"] &&
                            jQuery.data(jQuery("#myFieldId")[0], "events" )["keyup"][0] &&
                            jQuery.data(jQuery("#myFieldId")[0], "events" )["keyup"][0].handler
                            ) {
                               var keyupaction = jQuery.data(jQuery("#myFieldId")[0], "events" )["keyup"][0].handler;
                               AJS.$("#myFieldId").off("keyup");
                               AJS.$("#myFieldId").on("keyup", function() {
                                    if (AJS.$("#myFieldId").val() && AJS.$("#myFieldId").val().length > 2) {
                                       keyupaction.apply(null, Array.from(arguments));
                                    }
                               });
                               break;
                        }
                    }
                }, 1000);


               // AJS.$("#myFieldId").addEventListener("keyup", );

			    // Get the array of search terms entered by the user
			    
               var gadget123 = AJS.Gadget({
                    baseUrl: "__ATLASSIAN_BASE_URL__",
                    useOauth: "/rest/gadget/1.0/currentUser",                
					view:{
                        onResizeAdjustHeight: false,
                        onResizeReload: false,
						enableReload: true,
                        template: function(args) {
                            var gadget = this;
							usersSelected=document.getElementById('myFieldId').value;

                            gadget.getView().html(args.projectsobj.html);
                            	
                            AJS.$.ajax({
			            	  url: "/rest/logtime-gadget/1.0/projectsuser.json",
			            	  timeout: 9*60*1000, // 9 minutes for Alex Murashko
			            	  type: "GET",            	  
			            	  dataType: "json",
			            	  success: function(msg){
                                var ii=0;
                                AJS.$.each(msg.projects, function(idx, val) {
                                    if(search_project=="0" || search_project.lastIndexOf(val.id)!=-1){
                                        AJS.$('#s1').append("<option value='"+ii+"' selected=\"selected\">"+val.name+"</option>");
                                    } else {
                                        AJS.$('#s1').append("<option value='"+ii+"'>"+val.name+"</option>");
                                    }
                                    projectArr[ii++]=val.id;
                                });
                                AJS.$("#s1").dropdownchecklist({ firstItemChecksAll: true, explicitClose: '...close' });
                                AJS.$(".ui-dropdownchecklist-dropcontainer").css("max-height", "250px");
                                AJS.$(".ui-dropdownchecklist-dropcontainer").css("max-width", "300px");
                                AJS.$(".ui-dropdownchecklist-selector").css("max-width", "300px");
                            }
			            	});
			               
                        },
                        args: [
                        {
                            key: "projectsobj",
                            ajaxOptions: function() {
                                return {
                                    url: "/rest/logtime-gadget/1.0/projectsobj.json",
                                    timeout: 9*60*1000, // 9 minutes for Alex Murashko
                                    data: {
                                        projectId: this.getPref("project"),                                        
                                        noCache: (new Date()).getTime(),
                                        scnWl:scnWlCheck,
                                        extWl:extWlCheck,
                                        assignedCheck:assignedCheck,
                                        prjList: prj_check_list_string,
                                        usersSelected: usersSelected,
                                        viewType:buttonNameText,
                                        currentPeriod:currentPeriod,
                                        currentslideStep: slideStep
                                    }
                                };
                            }
                        }
                        ]
                    }				
                    
                }); 
                   	
         
            
            function checkboxScnClick(){
           	  scnWlCheck=document.getElementById('ScnWl').checked==true?1:0;
            }	

			function checkboxExtClick(){
           	  extWlCheck=document.getElementById('ExtWl').checked==true?1:0;
            }	
           
           function checkboxAssignedClick(){
           	  assignedCheck=document.getElementById('Assigned').checked==true?1:0;
           }	
           
                                   
             function checkProjects(prjId){
              	
              	for (ii=1; ii<=projectArr.length; ii++)
            	{
            		var check_id = "ddcl-s1-i"+ii;
            		if(projectArr[ii-1]==prjId){
            			document.getElementById(check_id).checked=true;
            		}
            	}
              	           
             };
            
            function reloadMeClean(){
            	slideStep = document.getElementById('slideStepHidden').value;
            	currentPeriod=0;
            	reloadMe();
            }
            
            
            function reloadMe(){
            	usersSelected = document.getElementById('myFieldId').value; 
            	if(usersSelected.replace(" ","")==""){
          //  		AJS.$( "#noUser" ).css("display","block");  
          //  		return;          		
            	}
            	else
            	{
            		AJS.$( "#noUser" ).css("display","none");
            	}
            	
           		AJS.$( ".gadget" ).remove();
           			
            	              
                prj_check_list_string="";
            	prj_check_cnt = 0;
            	console.log("selected projects:");
            	for (ii=1; ii<=projectArr.length; ii++)
            	{
            		var check_id = "ddcl-s1-i"+ii;
            		if (document.getElementById(check_id).checked==true)
            		{
            			prj_check_list[prj_check_cnt++]=projectArr[ii-1];
            			if(prj_check_list_string==""){
            				prj_check_list_string=projectArr[ii-1];
            			}else{            			
            				prj_check_list_string=prj_check_list_string + ", "+ projectArr[ii-1];
            			}
            			console.log(projectArr[ii-1]);
            		} 
            	}
            	
            	//prefs.set("wlScnCheck", document.getElementById('ScnWl').checked);
            //	prefs.set("wlExtCheck", document.getElementById('ExtWl').checked);
            //	prefs.setArray("userslist", [usersSelected]);     
            //	prefs.setArray("projectlist", [prj_check_list_string]);
             // 	gadget.setPref("width","1200");
            	
            	gadget123 = AJS.Gadget({
                    baseUrl: "__ATLASSIAN_BASE_URL__",
                    useOauth: "/rest/gadget/1.0/currentUser",                   
					view:{
                        onResizeAdjustHeight: true,
                        onResizeReload: true,
						enableReload: true,
                        template: function(args) {
                            var gadget = this;

                            gadget.getView().html(args.projectsobj.html);
                        },
                        args: [
                        {
                            key: "projectsobj",
                            ajaxOptions: function() {
                                return {
                                    url: "/rest/logtime-gadget/1.0/projectsobj.json",
                                    timeout: 9*60*1000, // 9 minutes for Alex Murashko
                                    data: {
                                        projectId: this.getPref("project"),                                        
                                        noCache: (new Date()).getTime(),
                                        scnWl:scnWlCheck,
                                        extWl:extWlCheck,
                                        assignedCheck:assignedCheck,
                                        prjList: prj_check_list_string,
                                        usersSelected: usersSelected,
                                        viewType:buttonNameText,
                                        currentPeriod:currentPeriod,
                                        currentslideStep: slideStep
                                    }
                                };
                            }
                        }
                        ]
                    }				
                    
                }); 
            //	gadget123.showView(true);
            	
			};
			
	
			
			 function changeView(){
           		
           	
           		if(document.getElementById('viewButton').innerHTML=="Weekly view"){           			
           			document.getElementById('viewButton').innerHTML="Monthly view";
           		}else{
           			document.getElementById('viewButton').innerHTML="Weekly view"
           		}
           		buttonNameText=document.getElementById('viewButton').innerHTML;
           		
           		
            	currentPeriod=1;
            	slideStep = document.getElementById('slideStepHidden').value;
            	reloadMe();
            	currentPeriod=0;
			};		
			
			
			function slideForward(){
				currentPeriod=0;	
				
				document.getElementById('slideStepHidden').value= parseInt(document.getElementById('slideStepHidden').value)+1;
				
				slideStep = document.getElementById('slideStepHidden').value;
				
				reloadMe();			
				
			}
			
			function slideBack(){
				currentPeriod=0;	
				
				document.getElementById('slideStepHidden').value= parseInt(document.getElementById('slideStepHidden').value)-1;							
				slideStep = document.getElementById('slideStepHidden').value;
				
				reloadMe();			
			}
			
			function customKeyUp(event,isScn,userIdentifier,identifierSE,value,idetifier){
			   	var keyCode = ('which' in event) ? event.which : event.keyCode;
				if(keyCode == 13){
					onFunctionLost1(isScn,userIdentifier,identifierSE);
				}
				if(keyCode == 27){
					closeInplace(value,idetifier);
				}
				if(keyCode == 9){
					onFunctionLost1(isScn,userIdentifier,identifierSE);
					var i = parseInt(idetifier) + 1;					
					openinplaceSlow(userIdentifier,identifierSE,i,isScn);			
				}
			}
			
			function popUpPress(event){
				var keyCode = ('which' in event) ? event.which : event.keyCode;
				if(keyCode == 13){
					if(!AJS.$(document.activeElement).is('textarea')){
						addUpdateWorklog();
					}	
				}
				if(keyCode == 27){
					cancelWorklogAJAX();
				}	
				
			}
			
			
        </script>


        ]]>
    </Content>
</Module>